<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: https://i.ytimg.com;"
    />
    <title>YouTube Downloader</title>
    <link rel="stylesheet" href="./src/style.css"/>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      const { useState, useEffect, useCallback, useMemo } = React;

      const formatBytes = (bytes, decimals = 2) => {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
      };

      function App() {
        const [url, setUrl] = useState("");
        const [videoDetails, setVideoDetails] = useState(null);
        const [history, setHistory] = useState([]);
        const [isLoading, setIsLoading] = useState(false);
        const [message, setMessage] = useState("");

        useEffect(() => {
          const fetchHistory = async () =>
            setHistory(await window.electronAPI.getHistory());
          fetchHistory();
        }, []);

        const handleUrlChange = (newUrl) => {
          setUrl(newUrl);
          if (!newUrl.trim()) setVideoDetails(null);
        };

        const handleFetchDetails = useCallback(async () => {
          if (!url) return;
          setIsLoading(true);
          console.log("Fetching details...");
          const result = await window.electronAPI.getVideoInfo(url);
          if (result.success) {
            setVideoDetails(result);
          } else {
            console.error(`Error: ${result.error}`);
            setVideoDetails(null);
          }
          setIsLoading(false);
        }, [url]);

        const goBackToHistory = () => {
          setUrl("");
          setVideoDetails(null);
        };

        return (
          <div className="app-container">
            <Header
              url={url}
              onUrlChange={handleUrlChange}
              onFetch={handleFetchDetails}
              isLoading={isLoading}
            />
            <main className="content-box">
              {isLoading ? (
                <div className='loading-component'  >
                  <div className="loader" ></div>

                </div>
              ) :  videoDetails ? (
                <DetailsView
                  details={videoDetails}
                  url={url}
                  onBack={goBackToHistory}
                  onDownloadComplete={async () =>
                    setHistory(await window.electronAPI.getHistory())
                  }
                />
              ) : (
                <HistoryView history={history} setHistory={setHistory} />
              )}

            </main>
          </div>
        );
      }

      const Header = ({ url, onUrlChange, onFetch, isLoading }) => (
        <header className="header">
          <input
            type="text"
            className="url-input"
            placeholder="Paste Video URL here"
            value={url}
            onChange={(e) => onUrlChange(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && onFetch()}
          />
          <button
            className="header-button"
            onClick={onFetch}
            disabled={!url || isLoading}
          >
            {isLoading ? "..." : "GET VIDEO"}
          </button>
        </header>
      );

      const HistoryView = ({ history, setHistory }) => {
        const handleClearHistory = async () => {
          await window.electronAPI.clearHistory();
          setHistory([]);
        };
        return (
          <div className="history-view">
            <div className="history-header">
              <h2 className="view-title">HISTORY</h2>
              {history.length > 0 && (
                <button
                  onClick={handleClearHistory}
                  className="clear-history-button"
                >
                  Clear All
                </button>
              )}
            </div>
            <div className="history-list">
              {history.length > 0 ? (
                history.map((item) => (
                  <div key={item.timestamp} className="history-item">
                    <img
                      src={item.thumbnailUrl}
                      className="history-thumbnail"
                      alt="Video thumbnail"
                    />
                    <div className="history-info">
                      <p
                        className="history-title"
                        onClick={() => window.electronAPI.openExternalLink(item.url)}
                      >
                        {item.title}
                      </p>
                      <p className="history-quality-format">{item.format}</p>
                      <button
                        className="history-button"
                        onClick={() =>
                          window.electronAPI.openFileLocation(item.path)
                        }
                      >
                        Show in Folder
                      </button>
                    </div>
                  </div>
                ))
              ) : (
                <p>Your download history will appear here.</p>
              )}
            </div>
          </div>
        );
      };

      const LoadingComponent = () =>{

        return (
        <div className="loading-component">
          Loading
        </div>
        )
      }

      const DetailsView = ({ details, url, onBack, onDownloadComplete }) => {
        const [selectedQuality, setSelectedQuality] = useState(
          details.formats[0]?.itag || ""
        );
        const [selectedType, setSelectedType] = useState("mp4");
        const [isDownloading, setIsDownloading] = useState(false);
        const [progress, setProgress] = useState(0);
        const [progressText, setProgressText] = useState("");
        const [downloadedFilePath, setDownloadedFilePath] = useState(null);

        const estimatedSize = useMemo(() => {
            if (selectedType === 'mp3') {
                return details.audioSizeFormatted || 'N/A';
            }
            const format = details.formats.find(f => f.itag == selectedQuality);
            return format?.sizeFormatted || "N/A";
        }, [selectedQuality, selectedType, details.formats, details.audioSizeFormatted]);

        useEffect(() => {
          const listener = ({ percent, downloaded, total }) => {
              setProgress(percent);
              setProgressText(`${formatBytes(downloaded)} / ${formatBytes(total)}`);
          };
          window.electronAPI.onDownloadProgress(listener);
        }, []);

        const handleDownload = async () => {
          setIsDownloading(true);
          setProgress(0);
          setProgressText("");
          setDownloadedFilePath(null);
          console.log("Initializing download...");

          const qualityLabel = details.formats.find(
            (f) => f.itag == selectedQuality
          )?.quality;

          const options = {
            ...details,
            url,
            quality: selectedQuality,
            qualityLabel,
            type: selectedType,
          };

          const result = await window.electronAPI.downloadVideo(options);
          if (result.success) {
            console.log("Success! File saved.");
            setDownloadedFilePath(result.path);
            onDownloadComplete();
          } else {
             if (result.error !== "Download was canceled.") {
                console.error(`Error: ${result.error}`);
              }
          }
          setIsDownloading(false);
        };

        const handleCancelDownload = () => {
            window.electronAPI.cancelDownload();
            setIsDownloading(false);
            setProgress(0);
            console.log("Download canceled by user.");
        };

        const handleThumbnailDownload = async () => {
          console.log("Saving thumbnail...");
          const result = await window.electronAPI.downloadThumbnail({
            url: details.thumbnailUrl,
            title: details.title,
          });
          if (result.success) {
            console.log(`Thumbnail saved!`);
          } else {
            console.error(`Error: ${result.error}`);
          }
        };

        return (
          <div className="details-view">
            <h2
              className="view-title"
              onClick={onBack}
            >
              &larr; BACK TO HISTORY
            </h2>
            <div className="details-layout-container">
              {/* --- Left Column --- */}
              <div className="details-left-column">

                {/* --- Top Group --- */}
                <div className="details-top-content">
                  <img
                    src={details.thumbnailUrl}
                    className="thumbnail"
                    alt="Video Thumbnail"
                  />

                  <button
                    className="header-button show-in-folder-button"
                    onClick={handleThumbnailDownload}
                    disabled={isDownloading}
                  >
                    Download Thumbnail
                  </button>

                  <div className="details-controls">
                    <select
                      className="details-select"
                      value={selectedType}
                      onChange={(e) => setSelectedType(e.target.value)}
                      disabled={isDownloading}
                    >
                      <option value="mp4">MP4 (Video)</option>
                      <option value="mp3">MP3 (Audio)</option>
                    </select>
                    <select
                      className="details-select"
                      value={selectedQuality}
                      onChange={(e) => setSelectedQuality(e.target.value)}
                      disabled={isDownloading || selectedType === "mp3"}
                    >
                      {details.formats.map((f) => (
                        <option key={f.itag} value={f.itag}>
                          {f.quality}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="download-actions">
                    {isDownloading ? (
                        <>
                            <button className="header-button" disabled>Downloading...</button>
                            <button className="header-button cancel-button" onClick={handleCancelDownload}>Cancel</button>
                        </>
                    ) : (
                        <div className="download-composite-button">
                            <button className="download-main-button" onClick={handleDownload}>
                                Download
                            </button>
                            <span className="download-size-indicator">{estimatedSize}</span>
                        </div>
                    )}
                  </div>
                </div>

                {/* --- Bottom Status Area --- */}
                <div className="status-area">
                  {isDownloading && (
                    <div className="progress-container">
                      <p className="progress-text">{progressText}</p>
                      <div className="progress-bar-container">
                        <div
                          className="progress-bar"
                          style={{ width: `${progress}%` }}
                        ></div>
                      </div>

                    </div>
                  )}
                  {!isDownloading && downloadedFilePath && (
                    <button className="header-button show-in-folder-button" onClick={() => window.electronAPI.openFileLocation(downloadedFilePath)}>
                        Show in Folder
                    </button>
                  )}
                </div>

              </div>

              {/* --- Right Column --- */}
              <div className="details-right-column">
                <h3 className="video-title">{details.title}</h3>
                <div className="description-wrapper">
                  <p className="video-description">{details.description}</p>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>